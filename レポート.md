# Next.js Hydrationエラー・レイアウト崩れ調査レポート

---

## ■ 現象・トラブル内容

- **Hydration failed because the server rendered HTML didn't match the client.**
  - SSR（サーバーサイドレンダリング）とCSR（クライアントサイドレンダリング）でHTMLが一致せず、ReactのHydrationエラーが発生。
  - エラー箇所は `<html lang="ja">` や `<body className={inter.className}>` で発生している。
- **ファーストビューの左右バランスが崩れている**
  - 左カラムが重く、右カラム（AIカード）が小さく右端に寄ってしまう。

---

## ■ catコマンドで出力した主な内容

### apps/frontend/src/app/layout.tsx
```tsx
import type { Metadata } from 'next';
import { Inter } from 'next/font/google';
import './globals.css';
import { AuthProvider } from '@/contexts/AuthProvider';

const inter = Inter({ subsets: ['latin'] });

export const metadata: Metadata = {
  title: 'Commit Coach',
  description: 'A project management tool for developers',
};

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="ja">
      <body className={inter.className}>
        <AuthProvider>{children}</AuthProvider>
      </body>
    </html>
  );
}
```

### apps/frontend/src/contexts/AuthProvider.tsx
- `"use client"` でクライアントコンポーネントとして宣言。
- Supabaseクライアントはハードコーディング。
- `useState`の初期値は静的。
- `window.location.origin`は関数内のみで使用。
- `useEffect`で認証状態を監視。

---

## ■ 調査すべきコードの場所

1. **レイアウトの根本**
   - `apps/frontend/src/app/layout.tsx`
2. **認証プロバイダー**
   - `apps/frontend/src/contexts/AuthProvider.tsx`
3. **ファーストビュー（ヒーローセクション）**
   - 例：`apps/frontend/src/app/page.tsx` または `components/Hero.tsx` など
4. **Next.js 設定**
   - `apps/frontend/next.config.mjs`
5. **Tailwind 設定**
   - `apps/frontend/tailwind.config.ts`
6. **グローバルCSS**
   - `apps/frontend/src/app/globals.css`

---

## ■ catコマンドで一撃確認コマンド例

```sh
cat apps/frontend/src/app/layout.tsx
cat apps/frontend/src/contexts/AuthProvider.tsx
cat apps/frontend/src/app/page.tsx
cat apps/frontend/src/components/Hero.tsx
cat apps/frontend/next.config.mjs
cat apps/frontend/tailwind.config.ts
cat apps/frontend/src/app/globals.css
```

---

## ■ 現象と原因・対策

### 1. Hydrationエラーの主な原因

- **SSR/CSRで異なる値を使っている**
  - 例：`window`や`localStorage`、`Date.now()`、`Math.random()`などを初期描画で使うとNG
  - **現状**：`layout.tsx`や`AuthProvider.tsx`では初期値は静的で、関数内でのみ`window`を使用しているため、直接的な原因は見当たらない。
- **Next.jsの設定ミス**
  - `next.config.mjs`の`experimental.serverActions`はオブジェクトで指定、`swcMinify`は削除
  - **現状**：警告が出ているため、設定ファイルの修正が必要。
- **Providerやコンポーネントの初期値のズレ**
  - **現状**：`useState`の初期値は静的で問題なし。
- **外部要因**
  - ブラウザ拡張や、`cz-shortcut-listen`などの属性が自動付与されている場合もHydrationエラーの原因となる。

### 2. レイアウト崩れの主な原因

- **左右のカラム幅・配置の不均等**
  - `flex-1`＋`max-w`＋`justify-center items-center`で左右均等＆中央寄せ
- **AIカードのサイズ・余白不足**
  - `min-w`や`min-h`、`p-12`などでカードを大きく
- **gap不足**
  - `gap-24`などで左右の間隔を広げる

---

## ■ 今後の調査・対策ポイント

1. **Next.jsの設定ファイル（next.config.mjs）を修正**
   - `experimental.serverActions`はオブジェクトで指定
   - `swcMinify`は削除
2. **ヒーローセクションやAIカードの実装ファイルをcatで確認し、SSR/CSR差分がないか再確認**
3. **ブラウザ拡張や外部要因も疑う（シークレットウィンドウで再現するか確認）**
4. **Hydrationエラーが消えるまで、怪しいProviderやコンポーネントを一時的に外して切り分ける**

---

## ■ まとめ

- **catコマンドで該当ファイルを一撃確認し、SSR/CSR差分やレイアウトの実装をチェック**
- **Hydrationエラーは「初期値の静的化」「Next.js設定修正」「クライアント依存値のuseEffect限定化」で解消**
- **レイアウト崩れは「左右の幅・中央寄せ・gap・カードサイズ調整」で解消**
- **catコマンドで出力した内容をもとに、さらに具体的な修正案を提示可能**
